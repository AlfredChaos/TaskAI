<template>
  <div class="reports-container">
    <!-- Â∑¶‰æßÊä•ÂëäÁÆ°ÁêÜ -->
    <div class="reports-sidebar">
      <!-- ÊêúÁ¥¢ÂíåËøáÊª§Âå∫Âüü -->
      <div class="search-section">
        <el-input v-model="searchQuery" placeholder="ÊêúÁ¥¢Êä•Âëä..." prefix-icon="Search" clearable @input="handleSearch" />

        <!-- ÂàõÂª∫Êä•ÂëäÊåâÈíÆ -->
        <el-button type="primary" @click="showCreateDialog = true">
          <el-icon>
            <Plus />
          </el-icon>
          ÂàõÂª∫Êä•Âëä
        </el-button>
      </div>

      <!-- ËøáÊª§Âô® -->
      <div class="filters">
        <el-select v-model="selectedType" placeholder="Êä•ÂëäÁ±ªÂûã" clearable @change="handleFilter">
          <el-option label="ÂÖ®ÈÉ®" value="" />
          <el-option label="Êó•Êä•" value="daily" />
          <el-option label="Âë®Êä•" value="weekly" />
        </el-select>

        <el-date-picker v-model="dateRange" type="daterange" range-separator="Ëá≥" start-placeholder="ÂºÄÂßãÊó•Êúü"
          end-placeholder="ÁªìÊùüÊó•Êúü" format="YYYY-MM-DD" value-format="YYYY-MM-DD" @change="handleFilter"
          style="height: 40px; line-height: 40px; border-radius: 10px; width: 100%;" />
      </div>

      <!-- Êä•ÂëäÂàóË°® -->
      <div class="reports-list">
        <div v-for="report in filteredReports" :key="report.id" class="report-card"
          :class="{ active: selectedReport?.id === report.id }" @click="selectReport(report)">
          <div class="report-header">
            <div class="report-icon">
              <el-icon v-if="report.type === 'daily'">
                <Calendar />
              </el-icon>
              <el-icon v-else>
                <DataAnalysis />
              </el-icon>
            </div>
            <div class="report-date">{{ formatDate(report.createdAt) }}</div>
          </div>

          <div class="report-content">
            <h4 class="report-title">{{ report.title }}</h4>
            <p class="report-preview">{{ getPreviewText(report.content) }}</p>
          </div>

          <div class="report-footer">
            <el-badge v-if="report.isNew" is-dot class="new-badge" />
          </div>
        </div>
      </div>
    </div>

    <!-- Âè≥‰æßAIËÅäÂ§©ÁïåÈù¢ -->
    <div class="chat-container">
      <!-- ËÅäÂ§©Â§¥ÈÉ® -->
      <div class="chat-header">
        <div class="ai-info">
          <div class="ai-avatar">
            <img :src="getAIProviderLogo(aiProvider)" :alt="aiProvider + ' Logo'" class="provider-logo"
              @error="handleImageError" />
          </div>
          <div class="ai-name">
            Êô∫ËÉΩÊä•ÂëäÂä©Êâã | {{ aiProvider }}
            <span v-if="isTyping" class="typing-indicator">Ê≠£Âú®ËæìÂÖ•...</span>
          </div>
        </div>

        <div class="chat-actions">
          <el-button type="text" @click="clearContext">
            <el-icon>
              <Delete />
            </el-icon>
            Ê∏ÖÈô§‰∏ä‰∏ãÊñá
          </el-button>
          <el-button type="text" @click="showProviderDialog = true">
            <el-icon>
              <Setting />
            </el-icon>
            AI‰æõÂ∫îÂïÜ
          </el-button>
        </div>
      </div>

      <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
      <div class="chat-messages" ref="messagesContainer">
        <div v-for="message in messages" :key="message.id" class="message-wrapper">
          <div class="message"
            :class="{ 'user-message': message.role === 'user', 'ai-message': message.role === 'assistant' }">
            <!-- Ê∂àÊÅØÂ§¥ÂÉè -->
            <div class="message-avatar">
              <!-- Áî®Êà∑Â§¥ÂÉè -->
              <el-avatar v-if="message.role === 'user'" :size="32" class="user-avatar">
                {{ getNameInitials('User') }}
              </el-avatar>
              <!-- AIÂ§¥ÂÉè -->
              <div v-else class="ai-message-avatar">
                <img :src="getAIProviderLogo(message.aiProvider || aiProvider)"
                  :alt="(message.aiProvider || aiProvider) + ' Logo'" class="ai-provider-logo"
                  @error="handleImageError" />
              </div>
            </div>
            <div class="message-right">
              <!-- AIÊÄùËÄÉËøáÁ®ã -->
              <div v-if="message.thinking && message.role === 'assistant'" class="thinking-wrapper">
                <div class="thinking-header" @click="message.expandedThinking = !message.expandedThinking">
                  <span class="thinking-title">ÊòæÁ§∫ÊÄùË∑Ø</span>
                  <el-icon class="thinking-toggle" :class="{ expanded: message.expandedThinking }">
                    <ArrowDown />
                  </el-icon>
                </div>
                <div v-if="message.expandedThinking" class="thinking-content">
                  <div class="thinking-text">{{ message.thinking }}</div>
                </div>
              </div>

              <!-- AIÂõûÂ§çÂÜÖÂÆπ - Áã¨Á´ãÂå∫Âüü -->
              <div class="message-content">
                <div class="message-text" v-html="renderMarkdown(message.content)"></div>

                <!-- ÂäüËÉΩÊåâÈíÆÔºà‰ªÖAIÊ∂àÊÅØÂêéÊòæÁ§∫Ôºâ -->
                <div v-if="message.role === 'assistant' && message.showActions" class="action-buttons">
                  <el-button type="primary" @click="generateReport('daily')">
                    <el-icon>
                      <Calendar />
                    </el-icon>
                    ÁîüÊàêÊó•Êä•
                  </el-button>
                  <el-button type="primary" @click="generateReport('weekly')">
                    <el-icon>
                      <DataAnalysis />
                    </el-icon>
                    ÁîüÊàêÂë®Êä•
                  </el-button>
                </div>
              </div>

              <!-- Ê∂àÊÅØÂÖÉ‰ø°ÊÅØ -->
              <div class="message-meta">
                <el-button type="text" size="small" @click="copyMessage(message.content)">
                  <el-icon>
                    <CopyDocument />
                  </el-icon>
                </el-button>
                <span v-if="message.tokens" class="token-count">{{ message.tokens }} tokens</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ÊµÅÂºèËæìÂá∫ÊåáÁ§∫Âô® -->
        <div v-if="isStreaming" class="streaming-indicator">
          <div class="message ai-message">
            <!-- AIÂ§¥ÂÉè -->
            <div class="message-avatar">
              <div class="ai-message-avatar">
                <img :src="getAIProviderLogo(aiProvider)" :alt="aiProvider + ' Logo'" class="ai-provider-logo"
                  @error="handleImageError" />
              </div>
            </div>
            <div class="message-right">
              <div class="message-content">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
      <div class="chat-input">
        <el-input v-model="inputMessage" type="textarea" :autosize="{ minRows: 3, maxRows: 6 }"
          placeholder="ËæìÂÖ•Ê∂àÊÅØ... ‰ΩøÁî®@ÊèêÂèäÈ°πÁõÆÊàñ‰ªªÂä°ÔºåÊåâEnterÂèëÈÄÅ" @keydown.enter="sendMessage" @input="handleInputChange" />

        <!-- @ÊèêÂèäÂª∫ËÆÆ -->
        <div v-if="showMentions" class="mentions-popup">
          <div v-for="item in mentionSuggestions" :key="item.id" class="mention-item" @click="selectMention(item)">
            <span class="mention-icon">{{ item.type === 'project' ? 'üìÅ' : 'üìã' }}</span>
            <span>{{ item.name }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ÂàõÂª∫Êä•ÂëäÂØπËØùÊ°Ü -->
    <el-dialog v-model="showCreateDialog" title="ÂàõÂª∫Êä•Âëä" width="600px">
      <el-form :model="newReport" label-width="80px">
        <el-form-item label="Êä•ÂëäÁ±ªÂûã">
          <el-radio-group v-model="newReport.type">
            <el-radio label="daily">Êó•Êä•</el-radio>
            <el-radio label="weekly">Âë®Êä•</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="Êä•ÂëäÊ†áÈ¢ò">
          <el-input v-model="newReport.title" placeholder="ËØ∑ËæìÂÖ•Êä•ÂëäÊ†áÈ¢ò" />
        </el-form-item>
        <el-form-item label="Êä•ÂëäÂÜÖÂÆπ">
          <el-input v-model="newReport.content" type="textarea" :rows="8" placeholder="ËØ∑ËæìÂÖ•Êä•ÂëäÂÜÖÂÆπÔºàÊîØÊåÅMarkdownÊ†ºÂºèÔºâ" />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showCreateDialog = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="createReport">ÂàõÂª∫</el-button>
      </template>
    </el-dialog>

    <!-- Êä•ÂëäËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog v-model="showReportDetail" title="Êä•ÂëäËØ¶ÊÉÖ" width="800px">
      <div v-if="selectedReport" class="report-detail">
        <div class="report-detail-header">
          <h3>{{ selectedReport.title }}</h3>
          <div class="report-meta">
            <el-tag :type="selectedReport.type === 'daily' ? 'primary' : 'success'">
              {{ selectedReport.type === 'daily' ? 'Êó•Êä•' : 'Âë®Êä•' }}
            </el-tag>
            <span class="report-date">{{ formatDate(selectedReport.createdAt) }}</span>
          </div>
        </div>

        <div class="report-detail-content">
          <div v-if="!isEditingReport" class="report-rendered" v-html="renderMarkdown(selectedReport.content)"></div>
          <el-input v-else v-model="editingContent" type="textarea" :rows="15" />
        </div>

        <div class="report-detail-actions">
          <el-button v-if="!isEditingReport" @click="startEditReport">ÁºñËæë</el-button>
          <el-button v-else @click="cancelEditReport">ÂèñÊ∂à</el-button>
          <el-button v-if="isEditingReport" type="primary" @click="saveReport">‰øùÂ≠ò</el-button>
          <el-button type="danger" @click="deleteReport">Âà†Èô§</el-button>
        </div>
      </div>
    </el-dialog>

    <!-- AI‰æõÂ∫îÂïÜËÆæÁΩÆÂØπËØùÊ°Ü -->
    <el-dialog v-model="showProviderDialog" title="AI‰æõÂ∫îÂïÜËÆæÁΩÆ" width="400px">
      <el-form label-width="100px">
        <el-form-item label="‰æõÂ∫îÂïÜ">
          <el-select v-model="aiProvider">
            <el-option label="DeepSeek" value="DeepSeek" />
            <el-option label="OpenAI" value="OpenAI" />
            <el-option label="Anthropic" value="Anthropic" />
          </el-select>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showProviderDialog = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="saveProviderSettings">‰øùÂ≠ò</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { defineOptions } from 'vue'

defineOptions({
  name: 'ReportsPage'
})
import { ref, reactive, computed, onMounted, nextTick } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Plus,
  Calendar,
  DataAnalysis,
  Delete,
  Setting,
  CopyDocument,
  ArrowDown
} from '@element-plus/icons-vue'
import MarkdownIt from 'markdown-it'
import { getNameInitials } from '@/utils'
// ÁßªÈô§AIProviderIconÁªÑ‰ª∂ÂØºÂÖ•

// ÂØºÂÖ•AI‰æõÂ∫îÂïÜLogoÈùôÊÄÅËµÑÊ∫ê
import deepseekLogo from '@/assets/deepseek.png'
import openaiLogo from '@/assets/openai.png'
import anthropicLogo from '@/assets/anthropic.png'

// MarkdownÊ∏≤ÊüìÂô®
const md = new MarkdownIt()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const searchQuery = ref('')
const selectedType = ref('')
const dateRange = ref<[string, string] | null>(null)
const selectedReport = ref<Report | null>(null)
const showCreateDialog = ref(false)
const showReportDetail = ref(false)
const showProviderDialog = ref(false)
const isEditingReport = ref(false)
const editingContent = ref('')
const inputMessage = ref('')
const isTyping = ref(false)
const isStreaming = ref(false)
const showMentions = ref(false)
const aiProvider = ref('DeepSeek')
const messagesContainer = ref<HTMLElement>()

// Êä•ÂëäÁ±ªÂûãÂÆö‰πâ
interface Report {
  id: string
  title: string
  content: string
  type: 'daily' | 'weekly'
  createdAt: string
  isNew?: boolean
}

// Ê∂àÊÅØÁ±ªÂûãÂÆö‰πâ
interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  thinking?: string
  tokens?: number
  showActions?: boolean
  expandedThinking?: boolean
  aiProvider?: string // ËÆ∞ÂΩïÊ∂àÊÅØÂàõÂª∫Êó∂ÁöÑAI‰æõÂ∫îÂïÜ
}

// Êñ∞Êä•ÂëäË°®Âçï
const newReport = reactive({
  title: '',
  content: '',
  type: 'daily' as 'daily' | 'weekly'
})

// Ê®°ÊãüÊä•ÂëäÊï∞ÊçÆ
const reports = ref<Report[]>([
  {
    id: '1',
    title: '2024Âπ¥12Êúà15Êó•Â∑•‰ΩúÊó•Êä•',
    content: '# ‰ªäÊó•Â∑•‰ΩúÊÄªÁªì\n\n## ÂÆåÊàê‰ªªÂä°\n- ÂÆåÊàê‰∫ÜÁî®Êà∑ÁÆ°ÁêÜÊ®°ÂùóÁöÑÂºÄÂèë\n- ‰øÆÂ§ç‰∫ÜÁôªÂΩïÈ°µÈù¢ÁöÑbug\n\n## ÊòéÊó•ËÆ°Âàí\n- ÂºÄÂßãÈ°πÁõÆÁÆ°ÁêÜÊ®°ÂùóÁöÑÂºÄÂèë',
    type: 'daily',
    createdAt: '2024-12-15',
    isNew: true
  },
  {
    id: '2',
    title: '2024Âπ¥Á¨¨50Âë®Â∑•‰ΩúÂë®Êä•',
    content: '# Êú¨Âë®Â∑•‰ΩúÊÄªÁªì\n\n## ‰∏ªË¶ÅÊàêÊûú\n- ÂÆåÊàê‰∫ÜÊï¥‰∏™Áî®Êà∑Á≥ªÁªüÁöÑÂºÄÂèë\n- ‰ºòÂåñ‰∫ÜÁ≥ªÁªüÊÄßËÉΩ\n\n## ‰∏ãÂë®ËÆ°Âàí\n- ÂºÄÂßãÊñ∞ÂäüËÉΩÁöÑËÆæËÆ°ÂíåÂºÄÂèë',
    type: 'weekly',
    createdAt: '2024-12-13'
  }
])

// ËÅäÂ§©Ê∂àÊÅØ
const messages = ref<Message[]>([
  {
    id: '1',
    role: 'assistant',
    content: '‰Ω†Â•ΩÔºÅÊàëÊòØÊô∫ËÉΩÊä•ÂëäÂä©ÊâãÔºåÂèØ‰ª•Â∏ÆÂä©‰Ω†ÁîüÊàêÂ∑•‰ΩúÊó•Êä•ÂíåÂë®Êä•„ÄÇÊàëËÉΩÂ§üÔºö\n\n - üìä ÂàÜÊûê‰Ω†ÁöÑÈ°πÁõÆËøõÂ∫¶Âíå‰ªªÂä°ÂÆåÊàêÊÉÖÂÜµ\n- üìù Ëá™Âä®ÁîüÊàêÁªìÊûÑÂåñÁöÑÊó•Êä•ÂíåÂë®Êä•\n- üîç Êï¥ÁêÜÂ∑•‰Ωú‰∫ÆÁÇπÂíåÂæÖÊîπËøõ‰∫ãÈ°π\n- üìà Êèê‰æõÊï∞ÊçÆÈ©±Âä®ÁöÑÂ∑•‰ΩúÊ¥ûÂØü\n\nËØ∑ÈÄâÊã©‰Ω†ÈúÄË¶ÅÁöÑÊúçÂä°ÔºåÊàñËÄÖÁõ¥Êé•ÂëäËØâÊàë‰Ω†ÁöÑÈúÄÊ±ÇÔºÅ',
    showActions: true,
    expandedThinking: false,
    aiProvider: 'DeepSeek'
  }
])

// ÊèêÂèäÂª∫ËÆÆÊï∞ÊçÆ
const mentionSuggestions = ref<Array<{ id: string; name: string; type: 'project' | 'task' }>>([])

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredReports = computed(() => {
  let filtered = reports.value

  // ÊêúÁ¥¢ËøáÊª§
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    filtered = filtered.filter(report =>
      report.title.toLowerCase().includes(query) ||
      report.content.toLowerCase().includes(query)
    )
  }

  // Á±ªÂûãËøáÊª§
  if (selectedType.value) {
    filtered = filtered.filter(report => report.type === selectedType.value)
  }

  // Êó•ÊúüËøáÊª§
  if (dateRange.value && dateRange.value.length === 2) {
    const [start, end] = dateRange.value
    filtered = filtered.filter(report => {
      const reportDate = new Date(report.createdAt)
      const startDate = new Date(start)
      const endDate = new Date(end)
      return reportDate >= startDate && reportDate <= endDate
    })
  }

  return filtered.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
})

// ÊñπÊ≥ïÂÆö‰πâ

/**
 * Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫
 */
const formatDate = (dateStr: string): string => {
  const date = new Date(dateStr)
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}

/**
 * Ëé∑ÂèñÊä•ÂëäÈ¢ÑËßàÊñáÊú¨
 */
const getPreviewText = (content: string): string => {
  // ÁßªÈô§markdownÊ†áËÆ∞ÔºåËé∑ÂèñÁ∫ØÊñáÊú¨
  const plainText = content.replace(/[#*`\[\]()]/g, '').replace(/\n/g, ' ')
  return plainText.length > 50 ? plainText.substring(0, 50) + '...' : plainText
}

/**
 * Ê∏≤ÊüìMarkdownÂÜÖÂÆπ
 */
const renderMarkdown = (content: string): string => {
  return md.render(content)
}

/**
 * Â§ÑÁêÜÊêúÁ¥¢
 */
const handleSearch = () => {
  // ÊêúÁ¥¢ÈÄªËæëÂ∑≤Âú®ËÆ°ÁÆóÂ±ûÊÄß‰∏≠Â§ÑÁêÜ
}

/**
 * Â§ÑÁêÜËøáÊª§
 */
const handleFilter = () => {
  // ËøáÊª§ÈÄªËæëÂ∑≤Âú®ËÆ°ÁÆóÂ±ûÊÄß‰∏≠Â§ÑÁêÜ
}

/**
 * ÈÄâÊã©Êä•Âëä
 */
const selectReport = (report: Report) => {
  selectedReport.value = report
  report.isNew = false // Ê†áËÆ∞‰∏∫Â∑≤ËØª
  showReportDetail.value = true
}

/**
 * ÂàõÂª∫Êä•Âëä
 */
const createReport = () => {
  if (!newReport.title || !newReport.content) {
    ElMessage.warning('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊä•Âëä‰ø°ÊÅØ')
    return
  }

  const report: Report = {
    id: Date.now().toString(),
    title: newReport.title,
    content: newReport.content,
    type: newReport.type,
    createdAt: new Date().toISOString().split('T')[0]
  }

  reports.value.unshift(report)
  showCreateDialog.value = false

  // ÈáçÁΩÆË°®Âçï
  newReport.title = ''
  newReport.content = ''
  newReport.type = 'daily'

  ElMessage.success('Êä•ÂëäÂàõÂª∫ÊàêÂäü')
}

/**
 * ÂºÄÂßãÁºñËæëÊä•Âëä
 */
const startEditReport = () => {
  if (selectedReport.value) {
    editingContent.value = selectedReport.value.content
    isEditingReport.value = true
  }
}

/**
 * ÂèñÊ∂àÁºñËæëÊä•Âëä
 */
const cancelEditReport = () => {
  isEditingReport.value = false
  editingContent.value = ''
}

/**
 * ‰øùÂ≠òÊä•Âëä
 */
const saveReport = () => {
  if (selectedReport.value) {
    selectedReport.value.content = editingContent.value
    isEditingReport.value = false
    ElMessage.success('Êä•Âëä‰øùÂ≠òÊàêÂäü')
  }
}

/**
 * Âà†Èô§Êä•Âëä
 */
const deleteReport = async () => {
  try {
    await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êä•ÂëäÂêóÔºü', 'Á°ÆËÆ§Âà†Èô§', {
      type: 'warning'
    })

    if (selectedReport.value) {
      const index = reports.value.findIndex(r => r.id === selectedReport.value!.id)
      if (index > -1) {
        reports.value.splice(index, 1)
        showReportDetail.value = false
        selectedReport.value = null
        ElMessage.success('Êä•ÂëäÂà†Èô§ÊàêÂäü')
      }
    }
  } catch {
    // Áî®Êà∑ÂèñÊ∂àÂà†Èô§
  }
}

/**
 * ÂèëÈÄÅÊ∂àÊÅØ
 */
const sendMessage = (event?: KeyboardEvent) => {
  // Â¶ÇÊûúÊòØÈîÆÁõò‰∫ã‰ª∂ÔºåÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºàÈò≤Ê≠¢Êç¢Ë°åÔºâ
  if (event) {
    event.preventDefault()
  }

  if (!inputMessage.value.trim() || isStreaming.value) return

  // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
  const userMessage: Message = {
    id: Date.now().toString(),
    role: 'user',
    content: inputMessage.value,
    expandedThinking: false
  }

  messages.value.push(userMessage)
  inputMessage.value = ''

  // Ê®°ÊãüAIÂõûÂ§ç
  simulateAIResponse()

  // ÊªöÂä®Âà∞Â∫ïÈÉ®
  nextTick(() => {
    scrollToBottom()
  })
}

/**
 * Ê®°ÊãüAIÊµÅÂºèÂõûÂ§ç
 */
const simulateAIResponse = async () => {
  isStreaming.value = true
  isTyping.value = true

  // Ê®°ÊãüÂª∂Ëøü
  await new Promise(resolve => setTimeout(resolve, 1000))

  const aiMessage: Message = {
    id: Date.now().toString(),
    role: 'assistant',
    content: 'ÊàëÁêÜËß£‰Ω†ÁöÑÈúÄÊ±Ç„ÄÇËÆ©Êàë‰∏∫‰Ω†ÁîüÊàê‰∏Ä‰ªΩËØ¶ÁªÜÁöÑÊä•Âëä„ÄÇ',
    thinking: 'Áî®Êà∑ËØ¢ÈóÆ‰∫ÜÂÖ≥‰∫éÊä•ÂëäÁîüÊàêÁöÑÈóÆÈ¢òÔºåÊàëÈúÄË¶ÅÂàÜÊûêÂΩìÂâçÁöÑÈ°πÁõÆÂíå‰ªªÂä°Êï∞ÊçÆÔºåÁÑ∂ÂêéÁîüÊàêÁõ∏Â∫îÁöÑÊä•ÂëäÂÜÖÂÆπ„ÄÇ',
    tokens: 156,
    expandedThinking: false,
    aiProvider: aiProvider.value
  }

  messages.value.push(aiMessage)
  isStreaming.value = false
  isTyping.value = false

  // ÊªöÂä®Âà∞Â∫ïÈÉ®
  nextTick(() => {
    scrollToBottom()
  })
}

/**
 * ÁîüÊàêÊä•Âëä
 */
const generateReport = async (type: 'daily' | 'weekly') => {
  isStreaming.value = true

  // Ê®°ÊãüAIÁîüÊàêÊä•Âëä
  await new Promise(resolve => setTimeout(resolve, 2000))

  const reportContent = type === 'daily'
    ? '# Â∑•‰ΩúÊó•Êä•\n\n## ‰ªäÊó•ÂÆåÊàê\n- ÂÆåÊàê‰∫ÜÊä•ÂëäÁ≥ªÁªüÁöÑÂºÄÂèë\n- ‰ºòÂåñ‰∫ÜÁî®Êà∑ÁïåÈù¢\n\n## ÊòéÊó•ËÆ°Âàí\n- ÊµãËØïÊñ∞ÂäüËÉΩ\n- ÂáÜÂ§á‰∏äÁ∫øÈÉ®ÁΩ≤'
    : '# Â∑•‰ΩúÂë®Êä•\n\n## Êú¨Âë®ÊàêÊûú\n- ÂÆåÊàê‰∫ÜÊï¥‰∏™Êä•ÂëäÁ≥ªÁªü\n- ÊèêÂçá‰∫ÜÂºÄÂèëÊïàÁéá\n\n## ‰∏ãÂë®ËÆ°Âàí\n- ÂºÄÂßãÊñ∞È°πÁõÆÁöÑËßÑÂàí'

  const aiMessage: Message = {
    id: Date.now().toString(),
    role: 'assistant',
    content: `Êàë‰∏∫‰Ω†ÁîüÊàê‰∫Ü‰∏Ä‰ªΩ${type === 'daily' ? 'Êó•Êä•' : 'Âë®Êä•'}ÔºåËØ∑Êü•ÁúãÔºö\n\n${reportContent}\n\n‰Ω†ÂèØ‰ª•ÂØπÂÜÖÂÆπËøõË°å‰øÆÊîπÔºåÁ°ÆËÆ§ÂêéÊàë‰ºöÂ∏Æ‰Ω†‰øùÂ≠ò„ÄÇ`,
    tokens: 234,
    expandedThinking: false,
    aiProvider: aiProvider.value
  }

  messages.value.push(aiMessage)
  isStreaming.value = false

  // ÊªöÂä®Âà∞Â∫ïÈÉ®
  nextTick(() => {
    scrollToBottom()
  })
}

/**
 * Â§ÑÁêÜËæìÂÖ•ÂèòÂåñÔºàÁî®‰∫é@ÊèêÂèäÂäüËÉΩÔºâ
 */
const handleInputChange = () => {
  const lastAtIndex = inputMessage.value.lastIndexOf('@')
  if (lastAtIndex !== -1 && lastAtIndex === inputMessage.value.length - 1) {
    showMentions.value = true
    // ËøôÈáåÂèØ‰ª•Âä†ËΩΩÈ°πÁõÆÂíå‰ªªÂä°Êï∞ÊçÆ
    mentionSuggestions.value = [
      { id: '1', name: 'È°πÁõÆA', type: 'project' },
      { id: '2', name: '‰ªªÂä°B', type: 'task' }
    ]
  } else {
    showMentions.value = false
  }
}

/**
 * ÈÄâÊã©ÊèêÂèäÈ°π
 */
const selectMention = (item: { id: string; name: string; type: 'project' | 'task' }) => {
  inputMessage.value = inputMessage.value.replace(/@$/, `@${item.name} `)
  showMentions.value = false
}

/**
 * Â§çÂà∂Ê∂àÊÅØÂÜÖÂÆπ
 */
const copyMessage = async (content: string) => {
  try {
    await navigator.clipboard.writeText(content)
    ElMessage.success('ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
  } catch {
    ElMessage.error('Â§çÂà∂Â§±Ë¥•')
  }
}

/**
 * Ê∏ÖÈô§ËÅäÂ§©‰∏ä‰∏ãÊñá
 */
const clearContext = async () => {
  try {
    await ElMessageBox.confirm(
      'Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü',
      'Á°ÆËÆ§Ê∏ÖÈô§',
      {
        confirmButtonText: 'Á°ÆËÆ§',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      })

    messages.value = [
      {
        id: '1',
        role: 'assistant',
        content: '‰Ω†Â•ΩÔºÅÊàëÊòØÊô∫ËÉΩÊä•ÂëäÂä©ÊâãÔºåÂèØ‰ª•Â∏ÆÂä©‰Ω†ÁîüÊàêÂ∑•‰ΩúÊó•Êä•ÂíåÂë®Êä•„ÄÇÊàëËÉΩÂ§üÔºö\n\n- üìä ÂàÜÊûê‰Ω†ÁöÑÈ°πÁõÆËøõÂ∫¶Âíå‰ªªÂä°ÂÆåÊàêÊÉÖÂÜµ\n- üìù Ëá™Âä®ÁîüÊàêÁªìÊûÑÂåñÁöÑÊó•Êä•ÂíåÂë®Êä•\n- üîç Êï¥ÁêÜÂ∑•‰Ωú‰∫ÆÁÇπÂíåÂæÖÊîπËøõ‰∫ãÈ°π\n- üìà Êèê‰æõÊï∞ÊçÆÈ©±Âä®ÁöÑÂ∑•‰ΩúÊ¥ûÂØü\n\nËØ∑ÈÄâÊã©‰Ω†ÈúÄË¶ÅÁöÑÊúçÂä°ÔºåÊàñËÄÖÁõ¥Êé•ÂëäËØâÊàë‰Ω†ÁöÑÈúÄÊ±ÇÔºÅ',
        showActions: true,
        expandedThinking: false,
        aiProvider: aiProvider.value
      }
    ]

    ElMessage.success('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§')
  } catch {
    // Áî®Êà∑ÂèñÊ∂à
  }
}

/**
 * ‰øùÂ≠òAI‰æõÂ∫îÂïÜËÆæÁΩÆ
 */
const saveProviderSettings = () => {
  showProviderDialog.value = false
  ElMessage.success('AI‰æõÂ∫îÂïÜËÆæÁΩÆÂ∑≤‰øùÂ≠ò')
}

/**
 * Ëé∑ÂèñAI‰æõÂ∫îÂïÜLogoË∑ØÂæÑ
 */
const getAIProviderLogo = (provider: string): string => {
  const logoMap: Record<string, string> = {
    'DeepSeek': deepseekLogo,
    'OpenAI': openaiLogo,
    'Anthropic': anthropicLogo
  }
  return logoMap[provider] || deepseekLogo
}

/**
 * Â§ÑÁêÜÂõæÁâáÂä†ËΩΩÈîôËØØ
 */
const handleImageError = (event: Event) => {
  const img = event.target as HTMLImageElement
  img.src = deepseekLogo // ‰ΩøÁî®ÈªòËÆ§ÂõæÁâá
}

/**
 * ÊªöÂä®Âà∞ËÅäÂ§©Â∫ïÈÉ®
 */
const scrollToBottom = () => {
  if (messagesContainer.value) {
    messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight
  }
}

// ‰øÆÊîπÂºπÂá∫ÁªÑ‰ª∂Ê†∑Âºè
const style = document.createElement('style')
style.innerHTML = `
.el-message-box {
  border-radius: 10px;

  .el-button {
    border-radius: 10px;
  }
  
  .el-button--primary {
    border: none;
    box-shadow: none;
  }
}
`
document.body.appendChild(style)

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÁöÑÂàùÂßãÂåñ
onMounted(() => {
  // ÂàùÂßãÂåñÈÄªËæë
})
</script>

<style scoped>
:deep(.el-dialog) {
  border-radius: 10px;

  .el-button {
    border-radius: 10px;
  }

  .el-button--primary {
    border: none;
    box-shadow: none;
  }
}

.reports-container {
  display: flex;
  border-radius: 10px;
  height: calc(100vh - 112px);
  background: white;
}

/* Â∑¶‰æßÊä•ÂëäÁÆ°ÁêÜ */
.reports-sidebar {
  width: 600px;
  max-width: 40%;
  display: flex;
  flex-direction: column;
}

.search-section {
  padding: 20px;
  width: 100%;
  display: flex;
  flex-direction: row;
  align-items: center;

  :deep(.el-input__wrapper) {
    border-radius: 10px;
    height: 40px;
    line-height: 40px;
    background: #f5f5f5;
    box-shadow: none;
    margin-right: 15px;
  }

  .el-button {
    height: 40px;
    line-height: 40px;
    border-radius: 10px;
    box-shadow: none;
    border: none;
  }
}

.filters {
  display: flex;
  flex-direction: row;
  padding-left: 20px;
  padding-right: 20px;

  :deep(.el-select__wrapper) {
    height: 40px;
    border-radius: 10px;
    margin-right: 15px;
  }
}

.reports-list {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.report-card {
  padding: 15px;
  margin-bottom: 10px;
  background: #EFF2F4;
  border: none;
  border-radius: 15px;
  cursor: pointer;
  transition: all 0.3s;
}

.report-card:hover {
  border-color: #409eff;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.1);
}

.report-card.active {
  border-color: #409eff;
  background: #f0f8ff;
}

.report-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.report-icon {
  color: #409eff;
  font-size: 18px;
}

.report-date {
  font-size: 12px;
  color: #999;
}

.report-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 5px 0;
  color: #333;
}

.report-preview {
  font-size: 12px;
  color: #666;
  margin: 0;
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.report-footer {
  margin-top: 10px;
  text-align: right;
}

.new-badge {
  font-size: 10px;
}

/* Âè≥‰æßËÅäÂ§©ÁïåÈù¢ */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 0 10px 10px 0;
}

.chat-header {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.ai-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.ai-avatar {
  display: flex;
  align-items: center;
}

.provider-logo {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  object-fit: cover;
  display: block;
}

.ai-name {
  font-weight: 600;
  color: #333;
}

.typing-indicator {
  margin-left: 10px;
  font-size: 12px;
  color: gray;
  font-weight: normal;
}

.chat-actions {
  display: flex;
  gap: 10px;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.message-wrapper {
  margin-bottom: 20px;
}

.message {
  max-width: 80%;
  display: flex;
  gap: 10px;
  align-items: flex-start;
}

.user-message {
  margin-left: auto;
  flex-direction: row-reverse;
}

.message-avatar {
  flex-shrink: 0;
}

.user-avatar {
  background: #409eff;
  color: white;
  font-weight: 600;
}

.ai-message-avatar {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ai-provider-logo {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  object-fit: cover;
  display: block;
}

.user-message .message-content {
  background: #409eff;
  color: white;
  padding: 12px 16px;
  border-radius: 18px 18px 4px 18px;
}

.ai-message .message-content {
  color: #333;
  border-radius: 18px 18px 18px 4px;
  max-width: 100%;
}

.message-right {
  margin-top: 8px;
  margin-left: 16px;
}

/* ÊÄùËÄÉËøáÁ®ãÊ†∑Âºè */
.thinking-wrapper {
  margin-bottom: 12px;
  border-radius: 10px;
  overflow: hidden;
}

.thinking-header {
  width: 100px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background-color: #f2f2f2;
  cursor: pointer;
  user-select: none;
  border-radius: 10px;
}

.thinking-title {
  font-size: 13px;
  font-weight: 500;
  color: black;
}

.thinking-toggle {
  transition: transform 0.3s ease;
}

.thinking-toggle.expanded {
  transform: rotate(180deg);
}

.thinking-content {
  padding: 0;
  overflow: hidden;
  background: white;
}

.thinking-text {
  margin-top: 16px;
  padding-left: 10px;
  font-size: 13px;
  color: #666;
  line-height: 1.5;
  border-left: 2px solid #ddd;
  background: white;
}

.message-text {
  line-height: 1.6;
}

/* MarkdownÊ∏≤ÊüìÂÜÖÂÆπÊ†∑Âºè */
.message-text ul,
.message-text ol {
  padding-left: 20px;
  margin: 10px 0;
  margin-left: 20px;
}

.action-buttons {
  margin-top: 15px;
  display: flex;
  gap: 10px;

  .el-button {
    border-radius: 10px;
    border: none;
    box-shadow: none;

    .el-icon {
      margin-right: 4px;
    }

    &::after {
      display: none;
    }
  }
}

.message-meta {
  margin-top: 4px;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  font-size: 12px;
  color: #999;

  .el-button--small {
    padding-left: 0;
    padding-right: 10px;
    font-size: 16px;
  }

  .el-icon {
    color: gray;
  }
}

.token-count {
  font-size: 16px;
  font-weight: 200;
  color: gray;
}

.streaming-indicator {
  margin-bottom: 20px;
}

.typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  background: #999;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {

  0%,
  60%,
  100% {
    transform: translateY(0);
  }

  30% {
    transform: translateY(-10px);
  }
}

.chat-input {
  padding: 20px;
  position: relative;

  :deep(.el-textarea__inner) {
    border-radius: 20px;
    background: #EFF2F4;
    border: none;
    box-shadow: none;
    padding: 20px;
    color: black;
  }
}

.mentions-popup {
  position: absolute;
  bottom: 100%;
  left: 20px;
  right: 20px;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
}

.mention-item {
  padding: 10px 15px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.mention-item:hover {
  background: #f5f5f5;
}

.mention-icon {
  font-size: 14px;
}

.input-actions {
  margin-top: 10px;
  text-align: right;
}

/* Êä•ÂëäËØ¶ÊÉÖÂØπËØùÊ°Ü */
.report-detail-header {
  margin-bottom: 20px;
}

.report-detail-header h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.report-meta {
  display: flex;
  align-items: center;
  gap: 10px;
}

.report-detail-content {
  margin-bottom: 20px;
  min-height: 300px;
}

.report-rendered {
  line-height: 1.8;
  color: #333;
}

.report-detail-actions {
  text-align: right;
}

.report-detail-actions .el-button {
  margin-left: 10px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .reports-container {
    flex-direction: column;
  }

  .reports-sidebar {
    width: 100%;
    height: 40%;
  }

  .chat-container {
    height: 60%;
  }
}
</style>